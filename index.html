<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>天賦能量測驗｜正式版</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700;900&display=swap" rel="stylesheet">

  <style>
    *{box-sizing:border-box}

    :root{
      --camel:#B07A3A;
      --camelText:#ffffff;
      --camelShadow: rgba(176,122,58,.30);
      --contentW: 980px;
      --darkRed:#7A1F1F;

    }

    html{
      height:100%;
      background:url("https://i.ibb.co/FbVWf5RN/2025-12-19-20-46-29.png") center/cover no-repeat fixed;
    }

    body{
      margin:0;
      min-height:100%;
      font-family:"Noto Sans TC",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:transparent;
      color:#111827;
      position:relative;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:rgba(255,255,255,.65);
      pointer-events:none;
      z-index:-1;
    }

    .section{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:20px;
      text-align:center;
      position:relative;
      z-index:1;
    }
    button{cursor:pointer}

    .blockW{
      width:100%;
      max-width:var(--contentW);
      margin:0 auto;
    }

    /* 開始頁 */
    #startPage h1{
      color:#c0822a;
      font-size:clamp(28px,5vw,40px);
      margin-bottom:12px;
    }
    #startPage p{
      font-size:16px;
      margin-bottom:20px;
      color:#374151;
      line-height:1.7;
    }
    #startPage button{
      padding:14px 28px;
      font-size:18px;
      font-weight:700;
      border:none;
      border-radius:14px;
      background:#8A571A;
      color:#fff;
      box-shadow:0 8px 24px rgba(138,87,26,.35);
    }
    #startPage button:hover{filter:brightness(1.05)}

    /* 題目頁 */
    #quizPage{display:none;text-align:left;}
    #quizInner{
      max-width:720px;
      width:100%;
      margin:0 auto;
      padding:20px 18px;
      border-radius:22px;
      position:relative;
      overflow:hidden;

      background:linear-gradient(
        180deg,
        rgba(255,255,255,.60) 0%,
        rgba(255,255,255,.30) 55%,
        rgba(108,74,242,.10) 100%
      );

      backdrop-filter: blur(14px) saturate(1.3);
      -webkit-backdrop-filter: blur(14px) saturate(1.3);

      border:1.5px solid rgba(255,255,255,.65);

      box-shadow:
        0 20px 56px rgba(17,24,39,.14),
        inset 0 0 0 1px rgba(255,255,255,.45);
    }

    #progress{font-size:14px;color:#6b7280;margin-bottom:8px;}
    #questionTitle{font-size:20px;font-weight:800;margin-bottom:14px;line-height:1.6;color:#111827;}

    .option{
      padding:12px 10px;
      border-radius:12px;
      border:1px solid rgba(17,24,39,.18);
      font-size:16px;
      margin-top:10px;
      background:transparent;
      color:#111827;
      transition:.18s;
      user-select:none;
    }
    .option:hover{
      border-color:#A56A2A;
      color:#7A4A1E;
      box-shadow:0 10px 24px rgba(165,106,42,.18);
      transform:translateY(-1px);
      background:rgba(165,106,42,.08);
    }
    .option.selected{
      border-color:#A56A2A;
      color:#7A4A1E;
      background:rgba(165,106,42,.14);
      box-shadow:0 14px 30px rgba(165,106,42,.22);
      transform:translateY(-1px);
    }

    #navRow{
      margin-top:18px;
      display:flex;
      justify-content:space-between;
      gap:8px;
    }
    #navRow button{
      flex:1;
      padding:10px 0;
      border-radius:10px;
      border:none;
      font-size:15px;
      font-weight:700;
    }
    #prevBtn{background:#f3f4f6;color:#111827;}
    #prevBtn:disabled{opacity:.4;cursor:not-allowed;}
    #nextBtn{
      background:var(--camel);
      color:var(--camelText);
      box-shadow:0 6px 18px var(--camelShadow);
    }

    /* 結果頁 */
    #resultPage{display:none;text-align:left;}
    #resultInner{
      max-width:var(--contentW);
      width:100%;
      margin:0 auto;
      padding:22px 18px 20px;
      border-radius:22px;
      position:relative;
      overflow:hidden;

      background:linear-gradient(
        180deg,
        rgba(255,255,255,.58) 0%,
        rgba(255,255,255,.28) 55%,
        rgba(108,74,242,.08) 100%
      );

      backdrop-filter: blur(14px) saturate(1.3);
      -webkit-backdrop-filter: blur(14px) saturate(1.3);

      border:1.5px solid rgba(255,255,255,.62);

      box-shadow:
        0 22px 60px rgba(17,24,39,.16),
        inset 0 0 0 1px rgba(255,255,255,.42);

      display:flex;
      flex-direction:column;
      gap:14px;
    }

    /* ✅ 1) 文字卡：我的天賦能量 + 文字解析 */
    #textBox{
      border-radius:18px;
      padding:16px 14px;
      background:rgba(255,255,255,.72);
      border:1px solid rgba(17,24,39,.10);
      box-shadow:0 10px 26px rgba(17,24,39,.06);
      text-align:left;
    }

    #energyTitle{
      font-weight:900;
      font-size:20px;
      letter-spacing:.2px;
      margin:0 0 10px;
      color:#111827;
    }

    #summaryLine{
      white-space:pre-wrap;
      font-size:15px;
      line-height:1.7;
      color:#374151;
      margin:0 0 10px;
      font-weight:700;
    }

    #finalTraitTitle{
      font-size:18px;
      font-weight:900;
      color:#111827;
      margin:10px 0 0;
      line-height:1.35;
    }
    #traitOneLine{
      font-size:15px;
      color:#374151;
      margin:6px 0 10px;
      font-weight:500;
      line-height:1.75;
      white-space:pre-wrap;
    }

    .kTitle{
      color:#7A1F1F;
      font-weight:800;
      margin:0 0 6px;
      font-size:14px;
      letter-spacing:.5px;
    }
    .kBody{
      white-space:pre-wrap;
      font-size:15px;
      line-height:1.85;
      color:#111827;
      margin:0;
      font-weight:400;
    }

    #kGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px 16px;
      margin-top:10px;
    }
    .kItem{
      background: rgba(255,255,255,.55);
      border: 1px solid rgba(17,24,39,.08);
      border-radius: 16px;
      padding: 12px 12px;
      box-shadow: 0 8px 18px rgba(17,24,39,.05);
    }
    @media (max-width: 760px){
      #kGrid{ grid-template-columns: 1fr; }
    }

    /* ✅ 2) 百分比小表格（置中、像你截圖那種） */
    #energyCard{
      border-radius:18px;
      padding:12px;
      background:rgba(255,255,255,.72);
      border:1px solid rgba(17,24,39,.10);
      box-shadow:0 10px 26px rgba(17,24,39,.06);
    }
 #energyTable{
  width:100%;
  display:grid;
  grid-template-columns: repeat(4, 1fr);
  gap:0;
  border-radius:12px;
  overflow:hidden;

  /* ✅ 整條不要白：改成半透明灰、帶一點玻璃感 */
  background:rgba(17,24,39,.10);
  border:1px solid rgba(17,24,39,.10);
}

.eCell{
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
  padding:10px 8px;

  /* ✅ 每格也不要白 */
  background:rgba(255,255,255,.35);

  border-right:1px solid rgba(0,0,0,.10);
  font-weight:800;
  backdrop-filter: blur(10px) saturate(1.2);
  -webkit-backdrop-filter: blur(10px) saturate(1.2);
}
.eCell:last-child{ border-right:none; }

.eLabel{
  color:#111827;
  font-weight:800;
}

/* ✅ % 數字暗紅 */
.eVal{
  color:var(--darkRed);
  font-weight:900;
}

@media(max-width:640px){
  #energyTable{ grid-template-columns: repeat(2, 1fr); }

  /* 右邊界：第二格、第四格不需要 */
  .eCell:nth-child(2),
  .eCell:nth-child(4){ border-right:none; }

  /* ✅ 中間橫線：前兩格是第一列，給底線 */
  .eCell:nth-child(1),
  .eCell:nth-child(2){
    border-bottom:1px solid rgba(0,0,0,.10);
  }
}

    /* ✅ 3) 雷達圖 → 圖片 */
    #vizRow{
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:stretch;
      margin-top:2px;
    }

    #radar{
      width:100%;
      max-width:var(--contentW);
      aspect-ratio:1/1;
      height:auto;
      display:block;
      margin:0 auto;
    }

    #traitImgs{
      width:100%;
      max-width:var(--contentW);
      margin:0 auto;
      display:grid;
      gap:10px;
      justify-items:stretch;
      align-items:stretch;
    }
    #traitImgs.one{ grid-template-columns:1fr; }
    #traitImgs.two{ grid-template-columns:1fr 1fr; }
    @media(max-width:520px){
      #traitImgs.two{ grid-template-columns:1fr; }
    }
@media (min-width: 900px){
  #radar{
    max-width: 800px;
  }
}


    #traitImgs img{
      width:100%;
      height:auto;
      display:block;
      object-fit:contain;
      border-radius:18px;
      background:rgba(255,255,255,.55);
      border:1px solid rgba(17,24,39,.06);
    }

    /* 底部按鈕 */
    #btnRow{
      margin-top:6px;
      display:flex;
      justify-content:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .pillBtn{
      padding:11px 18px;
      border:none;
      border-radius:999px;
      font-weight:900;
      font-size:15px;
      cursor:pointer;
      box-shadow:0 10px 24px var(--camelShadow);
      min-width:150px;
    }
    #againBtn{ background:var(--camel); color:var(--camelText); }
    #downloadBtn{
      background:#111827;
      color:#fff;
      box-shadow:0 10px 24px rgba(17,24,39,.25);
    }
    #downloadBtn[disabled]{opacity:.65;cursor:not-allowed;}

    /* 下載用分享舞台 */
    #shareStage{
      position:fixed;
      left:-99999px;
      top:-99999px;
      width:1080px;
      padding:64px;
      background:#f6f7fb;
    }
    #shareCard{
      background:#fff;
      border-radius:42px;
      padding:34px;
      border:1px solid rgba(17,24,39,.08);
      box-shadow:0 30px 70px rgba(17,24,39,.12);
    }
    #shareCard #traitImgs img{ max-height:360px; }
    #shareFooter{
      margin-top:14px;
      font-size:14px;
      color:#6b7280;
      text-align:center;
      font-weight:600;
    }
    .mainEnergy{
  color:#7A1F1F;/* 紅色 */
  font-weight:900;
}

  </style>
</head>

<body>

  <section id="startPage" class="section">
    <div>
      <h1>完成 25 題<br>測出你的天賦能量</h1>
      <p>用 8 大職涯特質，看見最適合你的賺錢方式<br>5 分鐘，就能把你的天賦地圖打開。</p>
      <button id="startBtn" type="button">開始作答</button>
    </div>
  </section>

  <section id="quizPage" class="section">
    <div id="quizInner">
      <div id="progress"></div>
      <div id="questionTitle"></div>
      <div id="options"></div>
      <div id="navRow">
        <button id="prevBtn" type="button">⬅ 上一題</button>
        <button id="nextBtn" type="button">下一題 ➜</button>
      </div>
    </div>
  </section>

  <section id="resultPage" class="section">
    <div id="resultInner">

      <!-- ✅ 1) 文字卡：我的天賦能量 + 文字解析 -->
      <div id="textBox" class="blockW">
        <div id="energyTitle">我的天賦能量</div>

        <div id="summaryLine"></div>

        <div id="finalTraitTitle"></div>
        <div id="traitOneLine"></div>

        <div id="kGrid">
          <div class="kItem">
            <div class="kTitle">【你的優勢】</div>
            <p class="kBody" id="advText"></p>
          </div>
          <div class="kItem">
            <div class="kTitle">【你的卡點】</div>
            <p class="kBody" id="blindText"></p>
          </div>
          <div class="kItem">
            <div class="kTitle">【順流方向】</div>
            <p class="kBody" id="wealthText"></p>
          </div>
          <div class="kItem">
            <div class="kTitle">【適合合作對象】</div>
            <p class="kBody" id="partnerText"></p>
          </div>
        </div>
      </div>

      <!-- ✅ 2) 百分比小表格 -->
      <div id="energyCard" class="blockW">
        <div id="energyTable" aria-label="能量百分比表格"></div>
      </div>

      <!-- ✅ 3) 雷達圖 → 圖片 -->
      <div id="vizRow" class="blockW">
        <canvas id="radar"></canvas>
        <div id="traitImgs"></div>
      </div>

      <div id="btnRow" class="blockW">
        <button id="againBtn" class="pillBtn" type="button">再測一次</button>
        <button id="downloadBtn" class="pillBtn" type="button">下載結果圖</button>
      </div>

    </div>
  </section>

  <div id="shareStage" aria-hidden="true">
    <div id="shareCard"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* ========= 題目（25 題） ========= */
const QUESTIONS = [
  { q:"1. 平常做事時，身邊的人最常怎麼形容你？", a:["想法、點子很多，腦袋轉很快","跟你相處很舒服，自然想跟你合作","做事前會先想風險，不太會衝動","東西會整理的完整，細節不太會出錯"]},
  { q:"2. 你「比較希望」別人怎麼看你？", a:["個性溫和、好相處，大家都會想找你","說到做到、交辦的事可以放心交給你","做決定很快，關鍵時刻能拍板","跟你在一起會覺得有能量、有帶動感"]},
  { q:"3. 哪一種情況，會讓你最有成就感？", a:["整個局勢在你掌握中，事情照你預期走","腦中想了很久的想法，真的被做出來","被大家肯定、被需要、被看見","抓到對的時機，順勢出手而且效果很好"]},
  { q:"4. 團隊合作時，你自然會站在哪個位置？", a:["負責丟想法、定方向、開新可能","對外溝通、協調人、串資源","排時程、控進度，確保事情往前走","建立流程、顧品質，避免出錯"]},
  { q:"5. 在一群人裡，你通常是？", a:["想到什麼就想試試看，不太被框住","帶動氣氛、讓大家比較有互動","先觀察狀況，想清楚再行動","話不多，但該做的事都會穩穩完成"]},
  { q:"6. 當壓力很大時，你最常靠什麼撐過去？", a:["告訴自己要再努力一點，硬撐也要撐","靈光一閃，突然想到解法","找人聊聊或請人幫忙","靠流程、效率，把事情一個個解掉"]},
  { q:"7. 哪一句話，最像你內心的真實狀態？", a:["我習慣自己想清楚再說","我需要有人互動，才比較有動力","我常常想太久，遲遲下不了決定","我真的受不了拖拖拉拉"]},
  { q:"8. 遇到重要選擇時，你通常會？", a:["聽聽別人的經驗，再決定","看大家怎麼選，感受一下氣氛","列清楚利弊、風險與成本","感覺對了就衝，邊走邊調整"]},
  { q:"9. 你最怕被貼上哪一種標籤？", a:["看起來很混、沒在認真","無聊、沒特色、不被注意","好像沒朋友、很邊緣","思考很亂、事情常出包"]},
  { q:"10. 哪一種工作畫面，你比較有感？", a:["談條件、買低賣高、掌握主導權","建立制度、流程、SOP","快速試錯、擴張、開新局","和人互動、合作、建立關係"]},
  { q:"11.如果可以選，你最想避開哪一種事？", a:["一直想新策略、新方向","分工協調、組織架構","流程設計、系統整理","一直對人、情緒勞動"]},
  { q:"12. 在團隊裡，大家最常期待你做什麼？", a:["找問題、指出哪裡怪怪的","提新方向、新點子","對外連結資源、拉合作","把事情真正做完、收好"]},
  { q:"13. 哪一件事最容易讓你卡關？", a:["主動經營人際關係","比價、算 CP 值","憑空想新點子","會要求細節、找錯誤"]},
  { q:"14. 你最有自信的一項能力是？", a:["想出沒人想過的點子","把對的人放在對的位置","算出最划算、最有效率的方案","把事情做到標準、不出差錯"]},
  { q:"15. 哪一種狀況最容易讓你內耗？", a:["團隊人際氣氛很差","沒規則、沒步驟、很混亂","邏輯前後不通、說不清楚","一直做重複、沒成長的事"]},
  { q:"16. 你特別受不了哪一種人？", a:["不守界線、情緒勒索","一成不變、不想改變","死不變通、沒有彈性","做事很亂、不收尾"]},
  { q:"17.別人最常稱讚你什麼？", a:["很會推動事情、很會說服","很會談判、拿到好條件","看問題很準，一針見血","想法很特別、很有創意"]},
  { q:"18. 哪一件事你最沒把握？", a:["把流程變得更好、更順","判斷趨勢、抓大方向","一直想出新玩法","長時間跟人互動不累"]},
  { q:"19. 什麼時候你會最開心？", a:["自己的創意被採用","認識到對的人、好夥伴","撿到好康、做出高 CP 的選擇","系統順順跑、事情很穩"]},
  { q:"20. 哪一件事最容易讓你煩躁？", a:["規則被亂破、沒底線","一直等、沒進度","人際關係冷掉、氣氛怪","不知道怎麼配合、很混亂"]},
  { q:"21. 工作時，你比較像哪一型？", a:["穩穩把關、守住品質","條理清楚、流程控","點子型、創意掛","外放型、互動掛"]},
  { q:"22. 別人用哪一個形容詞形容你，你會覺得很驚訝？", a:["很穩定","很有邏輯","很有創意","很外向"]},
  { q:"23. 你覺得自己做什麼最不費力？", a:["和人建立連結、拉關係","看出機會點、判斷時機","優化流程、讓事情更順","發想新方向、新可能"]},
  { q:"24. 快撐不住時，你最常依靠什麼？", a:["邏輯與理性判斷","天賦直覺、感覺","找人幫忙、一起扛","告訴自己再撐一下"]},
  { q:"25. 事情完成後，你第一個反應是？", a:["好好慶祝一下","感謝身邊幫忙的人","把收尾、整理做好","開始想下一步要幹嘛"]},
];

/* ========= DBTS 計分 ========= */
const SCORE_MAP = [
  { A:{D:+1}, B:{B:+1}, C:{T:+1}, D:{S:+1} },
  { A:{T:+1}, B:{S:+1}, C:{D:+1}, D:{B:+1} },
  { A:{S:+1}, B:{D:+1}, C:{B:+1}, D:{T:+1} },
  { A:{D:+1}, B:{B:+1}, C:{T:+1}, D:{S:+1} },
  { A:{D:+1}, B:{B:+1}, C:{T:+1}, D:{S:+1} },
  { A:{T:+1}, B:{D:+1}, C:{B:+1}, D:{S:+1} },
  { A:{S:+1}, B:{B:+1}, C:{T:+1}, D:{D:+1} },
  { A:{T:+1}, B:{B:+1}, C:{S:+1}, D:{D:+1} },
  { A:{T:+1}, B:{D:+1}, C:{B:+1}, D:{S:+1} },
  { A:{T:+1}, B:{S:+1}, C:{D:+1}, D:{B:+1} },
  { A:{D:-1}, B:{T:-1}, C:{S:-1}, D:{B:-1} },
  { A:{S:+1}, B:{D:+1}, C:{B:+1}, D:{T:+1} },
  { A:{B:-1}, B:{T:-1}, C:{D:-1}, D:{S:-1} },
  { A:{D:+1}, B:{B:+1}, C:{T:+1}, D:{S:+1} },
  { A:{B:+1}, B:{T:+1}, C:{S:+1}, D:{D:+1} },
  { A:{S:+1}, B:{B:+1}, C:{D:+1}, D:{T:+1} },
  { A:{B:+1}, B:{T:+1}, C:{S:+1}, D:{D:+1} },
  { A:{B:+1}, B:{D:+1}, C:{T:+1}, D:{S:+1} },
  { A:{D:+1}, B:{B:+1}, C:{T:+1}, D:{S:+1} },
  { A:{S:+1}, B:{D:+1}, C:{B:+1}, D:{T:+1} },
  { A:{S:+1}, B:{T:+1}, C:{D:+1}, D:{B:+1} },
  { A:{S:-1}, B:{T:-1}, C:{D:-1}, D:{B:-1} },
  { A:{B:+1}, B:{T:+1}, C:{S:+1}, D:{D:+1} },
  { A:{S:+1}, B:{D:+1}, C:{B:+1}, D:{T:+1} },
  { A:{D:+1}, B:{B:+1}, C:{T:+1}, D:{S:+1} },
];

function applyDelta(scores, delta){
  for(const k in delta) scores[k] = (scores[k] || 0) + delta[k];
}

function toPercentagesFromRaw(raw){
  const w = { D: Math.abs(raw.D||0), B: Math.abs(raw.B||0), T: Math.abs(raw.T||0), S: Math.abs(raw.S||0) };
  let sum = w.D + w.B + w.T + w.S;
  if(!sum) return { D:25, B:25, T:25, S:25 };

  let p = {
    D: Math.round(w.D / sum * 100),
    B: Math.round(w.B / sum * 100),
    T: Math.round(w.T / sum * 100),
    S: Math.round(w.S / sum * 100),
  };

  const total = p.D + p.B + p.T + p.S;
  const diff = 100 - total;
  if(diff !== 0){
    let best = "D", bestV = w.D;
    for(const k of ["B","T","S"]){ if(w[k] > bestV){ bestV=w[k]; best=k; } }
    p[best] += diff;
  }
  for(const k of ["D","B","T","S"]) p[k] = Math.max(0, Math.min(100, p[k]));
  return p;
}

function mapDBTS_to_8types(percentages){
  const { D, B, T, S } = percentages;

  // ✅ 同一種算法：兩能量加權（全部角色都一樣的算式）
  // w = 0.70 代表「這個角色比較偏向第一個能量」
  const mix = (a, b, w = 0.5) => Math.round(a * w + b * (1 - w));

  return {
    // 四個「角落」角色：偏向某主能量（70/30），但仍然是雙能量算法
    創作者: mix(D, B, 0.70), // 原本偏 D → 讓它仍偏 D，但跟 B 有連動
    支持者: mix(B, T, 0.70), // 原本偏 B → 讓它仍偏 B，但跟 T 有連動
    商人:   mix(T, B, 0.70), // 原本偏 T → 讓它仍偏 T，但跟 B 有連動
    地主:   mix(S, T, 0.70), // 原本偏 S → 讓它仍偏 S，但跟 T 有連動

    // 四個「邊」角色：就是兩能量 50/50（完全平均）
    技師:   mix(S, D, 0.50),
    明星:   mix(D, B, 0.50),
    媒合者: mix(B, T, 0.50),
    積蓄者: mix(T, S, 0.50),
  };
}


const ROLE_ORDER_8 = ["技師","創作者","明星","支持者","媒合者","商人","積蓄者","地主"];
function pickRoleBy8Types(type8){
  let best = ROLE_ORDER_8[0], bestV = type8[best] ?? -Infinity;
  for(const k of ROLE_ORDER_8){
    const v = type8[k] ?? -Infinity;
    if(v > bestV){ bestV = v; best = k; }
  }
  return best;
}

function pickMainEnergy(percentages){
  let best="D", bestV=percentages.D;
  for(const k of ["B","T","S"]){
    if(percentages[k] > bestV){ bestV=percentages[k]; best=k; }
  }
  return best;
}

const ENERGY_IMAGE = {
  B:'https://i.ibb.co/DsQ5JfD/1-0.png',
  D:'https://i.ibb.co/8DyWr929/2-0.png',
  T:'https://i.ibb.co/Z12ZYMS1/3-0.png',
  S:'https://i.ibb.co/WWkXCyg6/4-0.png'
};

const RADAR_THEME = {
  D: { stroke:"#16a34a", fill:"rgba(22,163,74,0.12)" },
  B: { stroke:"#dc2626", fill:"rgba(220,38,38,0.12)" },
  T: { stroke:"#f59e0b", fill:"rgba(245,158,11,0.14)" },
  S: { stroke:"#6b7280", fill:"rgba(107,114,128,0.14)" },
};

/* ✅ 解析文案（你原本那段我完整補回來了） */
const TRAIT_BLOCKS = {
  "創作者": {
    title:"創作者｜從 0 到 1 的發想靈感",
    oneLine:"代表人物：查理・布蘭森",
    adv:`• 點子源源不絕、直覺超準
• 有遠見、敢冒險、樂觀
• 敢於開頭，不怕從零出發`,
    blind:`• 沒耐心、時機感較弱
• 想法太多，反而很難完成
• 一個人硬撐會很孤單`,
    wealth:`• 只做發想，例如：策略、產品、創意
• 找對搭檔：支持者＋積蓄者
• 工具外包大腦，專注靈感
• 一定要動手做，不要只是想`,
    partner:`最合拍：支持者、積蓄者
原因：有人幫你落地＋幫你製作SOP
提醒：別找另一個創作者一起飛，容易一起發散`
  },

  "明星": {
    title:"明星｜用影響力打造品牌",
    oneLine:"代表人物：歐普拉・溫芙蕾",
    adv:`• 天生吸睛、很會說故事
• 溝通能力強、能激勵人心
• 個人品牌就是你的資產`,
    blind:`• 太在意形象，忽略內容
• 過度強勢，容易引發爭議
• 細節與系統會消耗你`,
    wealth:`• 主打溝通、行銷、領導
• 用真誠累積影響力
• 細節交給團隊
• 媒合者＋地主是神隊友`,
    partner:`最合拍：媒合者、地主
原因：你負責被看見，他們負責讓案子成交＋系統運轉
提醒：技師也很補你，但要先講清楚「標準」避免互相嫌`
  },

  "支持者": {
    title:"支持者｜把人聚在一起的人",
    oneLine:"代表人物：傑克・威爾許",
    adv:`• 很會經營人際關係、超會給信心
• 能把價值變成行動
• 團隊氣氛的靈魂人物`,
    blind:`• 不喜歡數字與細節
• 一個人時會迷失
• 不適合長時間獨立作業`,
    wealth:`• 領導、行銷、業務、顧問
• 一定要在團隊中
• 專注在人而不是事情`,
    partner:`最合拍：商人、技師
原因：你顧人與推進，他們顧流程與品質
提醒：商人也很合，但要先對齊「利益分配」就超穩`
  },

  "媒合者": {
    title:"媒合者｜把對的人放在對的位置",
    oneLine:"代表人物：唐納・川普",
    adv:`• 對時機超敏感
• 一對一關係的經營高手
• 談判、撮合的能力一流`,
    blind:`• 注意力分散
• 想讓所有人都滿意
• 架構不夠會失控`,
    wealth:`• 專注前線談案、媒合
• 建立人脈網絡
• 避開系統與細節工作`,
    partner:`最合拍：積蓄者、創作者
原因：你把局兜起來，創作者帶來新局，地主把後端接住
提醒：積蓄者也很補你，但節奏會偏慢，需要耐心`
  },

  "商人": {
    title:"商人｜擅長抓準時機",
    oneLine:"代表人物：喬治・索羅斯",
    adv:`• 超會抓 CP 值
• 時機感、洞察力強
• 談判與服務能力高`,
    blind:`• 看不清大局
• 信心起伏大
• 創意與策略較弱`,
    wealth:`• 投資、採購、執行、服務
• 發揮低買高賣天賦
• 不用逼自己當創意總監`,
    partner:`最合拍：地主、明星
原因：你抓機會與價格，他們幫你談成＋把流程做穩
提醒：創作者會帶你開新局，但要有人控風險`
  },

  "積蓄者": {
    title:"積蓄者｜累積是最重要的",
    oneLine:"代表人物：華倫・巴菲特",
    adv:`• 系統思維、風險控管
• 深度研究、不衝動
• 最穩定的財富型`,
    blind:`• 行動慢，被誤會拖延
• 社交曝光較弱`,
    wealth:`• 價值投資、長期持有
• 設定出手標準和時間
• 找技師＋支持者合作`,
    partner:`最合拍：技師、支持者
原因：你會評估＋守住紀律，技師顧細節，支持者顧推進
提醒：明星能加速曝光，但你要先確保「規則」不被打亂`
  },

  "地主": {
    title:"地主｜讓資產替你工作",
    oneLine:"代表人物：拉克希米・米塔爾",
    adv:`• 控制全局、重視效率
• 擅長後端、資產管理
• 喜歡安靜賺錢`,
    blind:`• 不愛人際互動
• 對曝光與行銷沒興趣`,
    wealth:`• 系統、數據、資產優化
• 當幕後大腦
• 避開演講與銷售`,
    partner:`最合拍：創作者、媒合者
原因：你顧後端與資源配置，他們顧前線開路
提醒：你們都偏內向時，記得找一個人負責對外`
  },

  "技師": {
    title:"技師｜把系統做到極致",
    oneLine:"代表人物：馬克・祖克柏",
    adv:`• 系統建構與優化
• 完成度高、重品質
• 一個人也能高效`,
    blind:`• 太鑽細節
• 社交場合耗能`,
    wealth:`• 接手現有系統來優化
• 小專案完成感最重要
• 不必從 0 開始`,
    partner:`最合拍：創作者、支持者
原因：創作者給方向，你負責落地；支持者負責協調與推進
提醒：被催時先定規格，反而更快`
  }
};


function analyzeTalent(answerArray){
  const raw = { D:0, B:0, T:0, S:0 };
  for(let i=0;i<QUESTIONS.length;i++){
    const v = answerArray[i];
    const letter = ["A","B","C","D"][v-1];
    applyDelta(raw, SCORE_MAP[i][letter]);
  }
  const percentages = toPercentagesFromRaw(raw);
  const type8 = mapDBTS_to_8types(percentages);
  const mainEnergy = pickMainEnergy(percentages);
  const final_trait = pickRoleBy8Types(type8);
  return { raw, percentages, type8, mainEnergy, final_trait };
}

/* ========= 作答流程 ========= */
let currentIndex = 0;
const answers = new Array(QUESTIONS.length);
const $ = (id)=>document.getElementById(id);

function startQuiz(){
  $("startPage").style.display="none";
  $("quizPage").style.display="flex";
  renderQuestion();
  window.scrollTo(0,0);
}

function renderQuestion(){
  const q = QUESTIONS[currentIndex];
  const total = QUESTIONS.length;
  $("progress").innerText = `第 ${currentIndex+1} / ${total} 題`;
  $("questionTitle").innerText = q.q;

  const selected = answers[currentIndex];
  $("options").innerHTML = q.a.map((txt,i)=>{
    const isSel = selected === (i+1);
    return `<div class="option ${isSel ? 'selected' : ''}" data-idx="${i}">${String.fromCharCode(65+i)}｜${txt}</div>`;
  }).join("");

  $("options").querySelectorAll(".option").forEach(el=>{
    el.addEventListener("click", ()=> pickOption(parseInt(el.dataset.idx,10)));
  });

  $("prevBtn").disabled = currentIndex===0;
  $("nextBtn").innerText = currentIndex === total-1 ? "看結果 ➜" : "下一題 ➜";
}

function pickOption(idx){
  answers[currentIndex] = idx+1;
  renderQuestion();
  if(currentIndex === QUESTIONS.length - 1) return;
  setTimeout(()=>{
    currentIndex++;
    renderQuestion();
    window.scrollTo(0,0);
  }, 120);
}

function prevQ(){
  if(currentIndex>0){
    currentIndex--;
    renderQuestion();
    window.scrollTo(0,0);
  }
}

function nextQ(){
  const a = answers[currentIndex];
  if(!a){ alert("這一題還沒作答喔～"); return; }
  if(currentIndex < QUESTIONS.length-1){
    currentIndex++;
    renderQuestion();
    window.scrollTo(0,0);
  }else{
    showResult();
  }
}

function restartQuiz(){
  for(let i=0;i<answers.length;i++) answers[i] = undefined;
  currentIndex = 0;
  $("resultPage").style.display = "none";
  $("quizPage").style.display   = "none";
  $("startPage").style.display  = "flex";
  window.scrollTo(0,0);
}

function resizeCanvasToDisplaySize(canvas){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  const size = Math.floor(Math.min(rect.width, rect.height)) || 420;
  const needW = Math.floor(size * dpr);
  const needH = Math.floor(size * dpr);
  if(canvas.width !== needW || canvas.height !== needH){
    canvas.width = needW;
    canvas.height = needH;
  }
  return { size, dpr };
}

/* ========= 雷達圖（你原本版本） ========= */
/* ========= 雷達圖（修正版：不會被裁切） ========= */
function drawRadar(type8, mainEnergyKey="D"){
  const c = $("radar");
  const ctx = c.getContext("2d");
  const { size, dpr } = resizeCanvasToDisplaySize(c);

  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,c.width,c.height);
  ctx.scale(dpr, dpr);

  const theme = RADAR_THEME[mainEnergyKey] || RADAR_THEME.D;

  const S = size;
  const cX = S/2, cY = S/2;

  // ✅ OUT_PAD 拉大：外圍標籤一定放得下（這是你 Vercel 會被裁的主因）
  const OUT_PAD = Math.round(
    Math.max(140, Math.min(260, S * 0.34))
  );

  const half = Math.max(10, (S/2) - OUT_PAD);

  const left = cX - half, right = cX + half;
  const top  = cY - half, bottom = cY + half;

  const r = half / 0.9238795325;

  const drawSquare = (h)=>{
    ctx.beginPath();
    ctx.moveTo(cX - h, cY - h);
    ctx.lineTo(cX + h, cY - h);
    ctx.lineTo(cX + h, cY + h);
    ctx.lineTo(cX - h, cY + h);
    ctx.closePath();
    ctx.stroke();
  };

  const octVertices = (rr)=>{
    const pts = [];
    for(let i=0;i<8;i++){
      const ang = (-90 + i*45) * Math.PI/180;
      pts.push({ x: cX + rr*Math.cos(ang), y: cY + rr*Math.sin(ang) });
    }
    return pts;
  };

  const drawOct = (rr)=>{
    const vs = octVertices(rr);
    ctx.beginPath();
    ctx.moveTo(vs[0].x, vs[0].y);
    for(let i=1;i<vs.length;i++) ctx.lineTo(vs[i].x, vs[i].y);
    ctx.closePath();
    ctx.stroke();
  };

  // ✅ 外框正方形
  ctx.save();
  ctx.setLineDash([]);
  ctx.strokeStyle = "#cfcfcf";
  ctx.lineWidth = Math.max(1.0, S * 0.0030);
  drawSquare(half);
  ctx.restore();

  const octIn = r * 0.42;
  const octOut = r * 0.84;

  // ✅ 八邊形兩層
  ctx.save();
  ctx.setLineDash([]);
  ctx.strokeStyle = "#d0d0d0";
  ctx.lineWidth = Math.max(1.0, S * 0.0030);
  drawOct(octIn);
  drawOct(octOut);
  ctx.restore();

  // ✅ 尺寸
  const dotR    = Math.max(3, Math.round(S * 0.010));
  const dotGap  = Math.max(14, Math.round(S * 0.038));
  const textGap = Math.max(16, Math.round(S * 0.048));
  const fontSize = Math.max(12, Math.round(S * 0.034));

  // ✅ 防裁切：把點/字都鎖在 canvas 範圍內
  const clamp = (v, min, max) => Math.min(max, Math.max(min, v));
  const PAD = Math.max(10, Math.round(S * 0.03));   // 畫布安全邊界
  const clampX = (x)=>clamp(x, PAD, S - PAD);
  const clampY = (y)=>clamp(y, PAD, S - PAD);

  const P0 = {
    "技師":   { dotX: left  - dotGap, dotY: top    - dotGap,  textX: left  - dotGap - textGap, textY: top    - dotGap - textGap, align:"right" },
    "創作者": { dotX: cX,            dotY: top    - dotGap,  textX: cX,                     textY: top    - dotGap - textGap, align:"center" },
    "明星":   { dotX: right + dotGap, dotY: top    - dotGap,  textX: right + dotGap + textGap, textY: top  - dotGap - textGap, align:"left" },
    "支持者": { dotX: right + dotGap, dotY: cY,              textX: right + dotGap + textGap, textY: cY,                      align:"left" },
    "媒合者": { dotX: right + dotGap, dotY: bottom + dotGap, textX: right + dotGap + textGap, textY: bottom + dotGap + textGap, align:"left" },
    "商人":   { dotX: cX,            dotY: bottom + dotGap,  textX: cX,                     textY: bottom + dotGap + textGap, align:"center" },
    "積蓄者": { dotX: left  - dotGap, dotY: bottom + dotGap, textX: left  - dotGap - textGap, textY: bottom + dotGap + textGap, align:"right" },
    "地主":   { dotX: left  - dotGap, dotY: cY,              textX: left  - dotGap - textGap, textY: cY,                      align:"right" },
  };

  // ✅ clamp 後的位置
  const P = {};
  for(const k in P0){
    P[k] = {
      ...P0[k],
      dotX: clampX(P0[k].dotX),
      dotY: clampY(P0[k].dotY),
      textX: clampX(P0[k].textX),
      textY: clampY(P0[k].textY),
    };
  }

  // ✅ 虛線射線
  ctx.save();
  ctx.setLineDash([S * 0.010, S * 0.010]);
  ctx.strokeStyle = "#d9d9d9";
  ctx.lineWidth = Math.max(1.0, S * 0.0028);
  ctx.lineCap = "butt";

  ctx.beginPath();
  const rayOrder = ["技師","創作者","明星","支持者","媒合者","商人","積蓄者","地主"];
  for(const name of rayOrder){
    ctx.moveTo(cX, cY);
    ctx.lineTo(P[name].dotX, P[name].dotY);
  }
  ctx.stroke();
  ctx.restore();

  // ✅ 標籤
  ctx.font = `${fontSize}px 'Noto Sans TC'`;
  ctx.textBaseline = "middle";

  const labels = ["技師","創作者","明星","支持者","媒合者","商人","積蓄者","地主"];
  for (const name of labels) {
    const pos = P[name];
    ctx.beginPath();
    ctx.fillStyle = "#f2c94c";
    ctx.arc(pos.dotX, pos.dotY, dotR, 0, Math.PI * 2);
    ctx.fill();

    ctx.fillStyle = "#000";
    ctx.textAlign = pos.align;
    ctx.fillText(name, pos.textX, pos.textY);
  }

  // ✅ 畫數值多邊形（你的原邏輯保留）
  const polyOut = octVertices(octOut);
  const cross = (ax, ay, bx, by) => ax*by - ay*bx;

  function rayIntersectPolygonMaxT(poly, ux, uy){
    let bestT = Infinity;
    for(let i=0;i<poly.length;i++){
      const p1 = poly[i];
      const p2 = poly[(i+1)%poly.length];
      const vx = p2.x - p1.x;
      const vy = p2.y - p1.y;

      const wx = p1.x - cX;
      const wy = p1.y - cY;

      const denom = cross(ux, uy, vx, vy);
      if(Math.abs(denom) < 1e-9) continue;

      const t = cross(wx, wy, vx, vy) / denom;
      const s = cross(wx, wy, ux, uy) / denom;

      if(t >= 0 && s >= 0 && s <= 1){
        if(t < bestT) bestT = t;
      }
    }
    return bestT;
  }

  function mapValueToK(value){
    const v = Math.max(0, Math.min(100, value || 0));
    let radius;
    if(v <= 30){
      radius = (octIn) * (v / 30);
    }else if(v <= 70){
      radius = octIn + (octOut - octIn) * ((v - 30) / 40);
    }else{
      radius = octOut;
    }
    return radius / octOut;
  }

  const angles = [-135,-90,-45,0,45,90,135,180].map(a=>a*Math.PI/180);
  const values = labels.map(k => (type8?.[k] ?? 0));
  const pts = [];

  for(let i=0;i<8;i++){
    const a = angles[i];
    const ux = Math.cos(a), uy = Math.sin(a);
    const tOuter = rayIntersectPolygonMaxT(polyOut, ux, uy);

    const k = mapValueToK(values[i]);
    const t = tOuter * k;

    pts.push({ x: cX + ux * t, y: cY + uy * t });
  }

  ctx.beginPath();
  ctx.moveTo(pts[0].x, pts[0].y);
  for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
  ctx.closePath();

  ctx.fillStyle = theme.fill;
  ctx.strokeStyle = theme.stroke;
  ctx.lineWidth = Math.max(1.4, S * 0.0050);
  ctx.fill();
  ctx.stroke();
}


/* ✅ 百分比小表格渲染 */
function renderEnergyTable(p){
  const table = $("energyTable");
  table.innerHTML = `
    <div class="eCell"><span class="eLabel">發電機：</span><span class="eVal">${p.D}%</span></div>
    <div class="eCell"><span class="eLabel">火焰：</span><span class="eVal">${p.B}%</span></div>
    <div class="eCell"><span class="eLabel">節奏：</span><span class="eVal">${p.T}%</span></div>
    <div class="eCell"><span class="eLabel">鋼鐵：</span><span class="eVal">${p.S}%</span></div>
  `;
}

/* ========= 結果 ========= */
function showResult(){
  if(answers.some(v=>!v)){
    alert("還有題目沒作答喔～");
    return;
  }

  const res = analyzeTalent(answers);
  const p = res.percentages;
  const type8 = res.type8;
  const main = res.mainEnergy;
  const role = res.final_trait;

  $("quizPage").style.display="none";
  $("resultPage").style.display="flex";

  const mainName = main === "D" ? "發電機" : main === "B" ? "火焰" : main === "T" ? "節奏" : "鋼鐵";

$("summaryLine").innerHTML =
  `你的主能量是<span class="mainEnergy">【${mainName}】</span><br>`+
  `你天賦順流角色是<span class="mainEnergy">【${role}】</span>`;



  const block = TRAIT_BLOCKS[role] || { title:`${role}`, oneLine:"", adv:"", blind:"", wealth:"", partner:"" };
  $("finalTraitTitle").textContent = block.title || role;
  $("traitOneLine").textContent = block.oneLine || "";
  $("advText").textContent = block.adv || "";
  $("blindText").textContent = block.blind || "";
  $("wealthText").textContent = block.wealth || "";
  $("partnerText").textContent = block.partner || "";

  renderEnergyTable(p);
  drawRadar(type8, main);

  const maxVal = Math.max(p.D, p.B, p.T, p.S);
  const topKeys = ["D","B","T","S"].filter(k => p[k] === maxVal).slice(0,2);
  const wrap = $("traitImgs");
  wrap.className = topKeys.length === 1 ? "one" : "two";
  wrap.innerHTML = topKeys.map(k =>
    `<img crossorigin="anonymous" referrerpolicy="no-referrer" loading="eager" decoding="sync" src="${ENERGY_IMAGE[k] || ""}" alt="${k}">`
  ).join("");

  window.scrollTo(0,0);
}

/* ========= 下載（保留你原本） ========= */
function waitForImages(root){
  const imgs = Array.from(root.querySelectorAll("img"));
  return Promise.all(imgs.map(img => {
    if(img.complete && img.naturalWidth > 0) return Promise.resolve();
    return new Promise(res => {
      img.addEventListener("load", res, { once:true });
      img.addEventListener("error", res, { once:true });
    });
  }));
}

async function downloadResult(){
  const btn = $("downloadBtn");
  btn.disabled = true;
  const oldText = btn.textContent;
  btn.textContent = "下載中…";

  try{
    const shareCard = $("shareCard");
    shareCard.innerHTML = "";

    const clone = $("resultInner").cloneNode(true);
    const br = clone.querySelector("#btnRow");
    if(br) br.remove();

    const liveCanvas = $("radar");
    const canvasImg = document.createElement("img");
    canvasImg.src = liveCanvas.toDataURL("image/png");
    canvasImg.style.width = "100%";
    canvasImg.style.maxWidth = getComputedStyle(document.documentElement).getPropertyValue("--contentW").trim() || "980px";
    canvasImg.style.display = "block";
    canvasImg.style.margin = "0 auto";

    const cloneCanvas = clone.querySelector("#radar");
    if(cloneCanvas && cloneCanvas.parentNode){
      cloneCanvas.parentNode.replaceChild(canvasImg, cloneCanvas);
    }

    clone.querySelectorAll("img").forEach(img=>{
      img.setAttribute("crossorigin","anonymous");
      img.setAttribute("loading","eager");
      img.setAttribute("decoding","sync");
      img.referrerPolicy = "no-referrer";
    });

    shareCard.appendChild(clone);

    const foot = document.createElement("div");
    foot.id = "shareFooter";
    foot.textContent = "天賦能量測驗｜結果分享卡";
    shareCard.appendChild(foot);

    await waitForImages(shareCard);

    const canvas = await html2canvas($("shareStage"), {
      scale: 2,
      useCORS: true,
      allowTaint: false,
      backgroundColor: "#f6f7fb",
      windowWidth: 1080,
    });

    const a = document.createElement("a");
    const stamp = new Date().toISOString().slice(0,10);
    a.download = `天賦能量測驗_結果_${stamp}.png`;
    a.href = canvas.toDataURL("image/png");
    a.click();

  }catch(err){
    console.error(err);
    alert("下載失敗：很可能是圖片來源不支援跨網域（CORS），所以被瀏覽器擋住了。");
  }finally{
    btn.disabled = false;
    btn.textContent = oldText;
  }
}

/* ✅ 事件綁定：click + touchstart（避免你說的「按了沒反應」） */
window.addEventListener("DOMContentLoaded", ()=>{
  const startBtn = $("startBtn");
  if(startBtn){
    startBtn.addEventListener("click", startQuiz);
    startBtn.addEventListener("touchstart", (e)=>{ e.preventDefault(); startQuiz(); }, { passive:false });
  }

  const prevBtn = $("prevBtn");
  const nextBtn = $("nextBtn");
  const againBtn = $("againBtn");
  const downloadBtn = $("downloadBtn");

  if(prevBtn) prevBtn.addEventListener("click", prevQ);
  if(nextBtn) nextBtn.addEventListener("click", nextQ);
  if(againBtn) againBtn.addEventListener("click", restartQuiz);
  if(downloadBtn) downloadBtn.addEventListener("click", downloadResult);
});
</script>

</body>
</html>









